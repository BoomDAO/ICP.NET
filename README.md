# ICP.NET
Collection of Internet Computer Protocol (ICP) libraries for .NET/Blazor

- Agent
  - Library to communicate to and from the Internet Computer
  - Nuget: [`EdjCase.ICP.Agent`](https://www.nuget.org/packages/EdjCase.ICP.Agent)

- Candid
  - Library of Candid Encoding, Models and Helpers
  - Nuget: [`EdjCase.ICP.Candid`](https://www.nuget.org/packages/EdjCase.ICP.Candid)

- Client Generator
  - Library of generating C# client code from *.did files
  - Nuget: [`EdjCase.ICP.ClientGenerator`](https://www.nuget.org/packages/EdjCase.ICP.ClientGenerator)

- Samples
  - A few projects to demo the capabilities of the ICP libraries
    - Blazor
    - AspNetCore
    - CLI

# Agent
## Usage (Manual)
```cs
// Create identity
var identity = new AnonymousIdentity();

// Create http agent
IAgent agent = new HttpAgent(identity);

// Create Candid arg to send in request
ulong proposalId = 1234;
CandidArg arg = CandidArg.FromCandid(
    CandidValueWithType.FromObject(proposalId)
);

// Make request to IC
string method = "get_proposal_info";
Principal governanceCanisterId = Principal.FromText("rrkah-fqaaa-aaaaa-aaaaq-cai");
QueryResponse response = await agent.QueryAsync(governanceCanisterId, method, arg);

QueryReply reply = response.ThrowOrGetReply();
// Convert to custom class
ProposalInfo? info = reply.Arg.Values[0].ToObjectOrDefault<ProposalInfo>()
```

## Usage (w/ Client Generator)
- Run Client Generator on `*.did` file (see Client Generator below)
```cs
// Create identity
var identity = new AnonymousIdentity();

// Create http agent
IAgent agent = new HttpAgent(identity);

// Create new instance of client generated by `Client Generator` (this is using Governance.did for the NNS)
var client = new GovernanceApiClient(agent, Principal.FromText("rrkah-fqaaa-aaaaa-aaaaq-cai"));

// Make request
ProposalInfo? info = await client.GetProposalInfoAsync(62143);
```

# Candid
## Parse from bytes
```cs
CandidArg arg = CandidArg.FromBytes(rawCandidBytes);
```

## Reading candid values directly
```cs
CandidArg arg = CandidArg.FromBytes(rawCandidBytes);
CandidValue firstArg = arg.Values[0];
string title = firstArg.AsRecord()["title"];
```

## Converting candid to custom classes
```cs
// Custom class
public class MyObj
{
    public string Title { get; set; }
    public bool IsGoodTitle { get; set; }
}
```

```cs
// Deserialize
CandidArg arg = CandidArg.FromBytes(rawCandidBytes);
MyObj obj = arg.Values[0].ToObject<MyObj>();
```
```cs
// Serialze
MyObj obj = new MyObj
{
    Title = "Title 1",
    IsGoodTitle = false
};
CandidValueWithType value = CandidValueWithType.FromObject(obj);
```
## Parse from Text
```cs
string text = "record { field_1:nat64; field_2: vec nat8 }";
CandidRecordType type = CandidTextParser.Parse<CandidRecordType>(text);
```

## Generate Text representation
```cs
var type = new CandidRecordType(new Dictionary<CandidTag, CandidType>
{
    {
        CandidTag.FromName("field_1"),
        new CandidPrimitiveType(PrimitiveType.Nat64)
    },
    {
        CandidTag.FromName("field_2"),
        new CandidVectorType(new CandidPrimitiveType(PrimitiveType.Nat8))
    }
});
string text = CandidTextGenerator.Generator(type, IndentType.Tab);
```

# Client Generator
## Usage (Code)
```cs
    // Location of the `*.did` file to parse from
    string candidFilePath = "location/to/service.did";

    // Directory to create *.cs source code.
    string outputDirectory = "location/to/output";

    // Base namespace to give all *.cs files
    string @namespace = "My.Namespace.IC"

    // Optional, will use file name or type name if unspecified
    string? clientName = "MyClient";
    ClientFileGenerator.WriteClientFiles(candidFilePath, outputDirectory, @namespace, clientName);
```

## Usage (dotnet tool)
### Install with dotnet tools
```
dotnet tool install EdjCase.ICP.ClientGenerator --version 1.0.1
```
### Run tool
```
dotnet candid-client-generator -f "location/to/service.did" -o "location/to/output" -n "My.Namespace.IC" -c "MyClient"
```

# Links
- [IC Http Interface Spec](https://smartcontracts.org/docs/current/references/ic-interface-spec)
- [Candid Spec](https://github.com/dfinity/candid/blob/master/spec/Candid.md)
- [Candid Decoder](https://fxa77-fiaaa-aaaae-aaana-cai.raw.ic0.app/explain)
- [Candid UI Tester](https://a4gq6-oaaaa-aaaab-qaa4q-cai.raw.ic0.app)